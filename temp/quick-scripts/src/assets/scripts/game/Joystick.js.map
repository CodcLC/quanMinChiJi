{"version":3,"sources":["assets\\scripts\\game\\Joystick.js"],"names":["cc","Class","Component","properties","dot","type","Node","displayName","tooltip","ring","player","joystickType","JoystickCommon","JoystickType","FIXED","directionType","DirectionType","ALL","_stickPos","_touchLocation","onLoad","_radius","width","_initTouchEvent","FOLLOW","node","opacity","self","on","EventType","TOUCH_START","_touchStartEvent","TOUCH_MOVE","_touchMoveEvent","TOUCH_END","_touchEndEvent","TOUCH_CANCEL","event","undefined","touchPos","convertToNodeSpaceAR","getLocation","getPosition","distance","sub","mag","setPosition","posX","x","posY","y","p","v2","normalize","setSpeedType","SpeedType","FAST","setDir","STOP"],"mappings":"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","sourceRoot":"/","sourcesContent":["import JoystickCommon from 'JoystickCommon'\n\ncc.Class({\n  extends: cc.Component,\n\n  properties: {\n    dot: {\n      default: null,\n      type: cc.Node,\n      displayName: '杆子',\n      tooltip: '摇杆操纵点',\n    },\n    ring: {\n      default: null,\n      type: cc.Node,\n      displayName: '底部圈子',\n      tooltip: '摇杆背景节点',\n    },\n\n    player: {\n      default: null,\n      type: cc.Node,\n      displayName: '操控角色',\n      tooltip: '操控角色',\n    },\n\n    joystickType: {\n      default: JoystickCommon.JoystickType.FIXED,\n      type: JoystickCommon.JoystickType,\n      displayName: '触摸类型',\n      tooltip: '定死的还是随触摸位置变化的',\n    },\n    directionType: {\n      default: JoystickCommon.DirectionType.ALL,\n      type: JoystickCommon.DirectionType,\n      displayName: '方向限制',\n      tooltip: '四向，八向，万向',\n    },\n    _stickPos: {\n      default: null,\n      type: cc.Node,\n      tooltip: '摇杆所在位置',\n    },\n    _touchLocation: {\n      default: null,\n      type: cc.Node,\n      tooltip: '触摸位置',\n    },\n  },\n\n  onLoad() {\n    this._radius = this.ring.width / 2;\n    this._initTouchEvent();\n    // hide joystick when follow\n    if (this.joystickType == JoystickCommon.JoystickType.FOLLOW) {\n      this.node.opacity = 0;\n    }\n  },\n\n  _initTouchEvent() {\n    // set the size of joystick node to control scale\n    const self = this;\n    self.node.on(cc.Node.EventType.TOUCH_START, self._touchStartEvent, self);\n    self.node.on(cc.Node.EventType.TOUCH_MOVE, self._touchMoveEvent, self);\n    self.node.on(cc.Node.EventType.TOUCH_END, self._touchEndEvent, self);\n    self.node.on(cc.Node.EventType.TOUCH_CANCEL, self._touchEndEvent, self);\n  },\n\n  _touchStartEvent(event) {\n    if (this.player == null || this.player == undefined) return\n    // this.player = this.player.getComponent('Player') || this.player.getComponent('ParatrooperPlayer')\n\n    const touchPos = this.node.convertToNodeSpaceAR(event.getLocation());\n\n    if (this.joystickType === JoystickCommon.JoystickType.FIXED) {\n      this._stickPos = this.ring.getPosition();\n\n      // 触摸点与圆圈中心的距离\n      const distance = touchPos.sub(this.ring.getPosition()).mag();\n\n      // 手指在圆圈内触摸,控杆跟随触摸点\n      if (this._radius > distance) {\n        this.dot.setPosition(touchPos);\n      }\n\n    } else if (this.joystickType === JoystickCommon.JoystickType.FOLLOW) {\n\n      // 记录摇杆位置，给 touch move 使用\n      this._stickPos = touchPos;\n      this.node.opacity = 255;\n      this._touchLocation = event.getLocation();\n\n      // 更改摇杆的位置\n      this.ring.setPosition(touchPos);\n      this.dot.setPosition(touchPos);\n    }\n  },\n\n  _touchMoveEvent(event) {\n    if (this.joystickType === JoystickCommon.JoystickType.FOLLOW) {\n      // 如果 touch start 位置和 touch move 相同，禁止移动\n      if (this._touchLocation === event.getLocation()) {\n        return false;\n      }\n    }\n\n    // 以圆圈为锚点获取触摸坐标\n    const touchPos = this.ring.convertToNodeSpaceAR(event.getLocation());\n    const distance = touchPos.mag();\n\n    // 由于摇杆的 postion 是以父节点为锚点，所以定位要加上 touch start 时的位置\n    const posX = this._stickPos.x + touchPos.x;\n    const posY = this._stickPos.y + touchPos.y;\n\n    // 归一化\n    const p = cc.v2(posX, posY).sub(this.ring.getPosition()).normalize();\n\n    if (this._radius > distance) {\n      this.dot.setPosition(cc.v2(posX, posY));\n      // this.player.setSpeedType(JoystickCommon.SpeedType.NORMAL)\n    } else {\n      // 控杆永远保持在圈内，并在圈内跟随触摸更新角度\n      const x = this._stickPos.x + p.x * this._radius;\n      const y = this._stickPos.y + p.y * this._radius;\n      this.dot.setPosition(cc.v2(x, y));\n      // this.player.setSpeedType(JoystickCommon.SpeedType.FAST)\n    }\n    if (this.player == null || this.player == undefined) return\n    this.player.setSpeedType(JoystickCommon.SpeedType.FAST)\n    // this.player.moveDir = p\n    this.player.setDir(p)\n  },\n\n  _touchEndEvent() {\n    this.dot.setPosition(this.ring.getPosition());\n    if (this.joystickType == JoystickCommon.JoystickType.FOLLOW) {\n      this.node.opacity = 0;\n    }\n    if (this.player == null || this.player == undefined) return\n    this.player.setSpeedType(JoystickCommon.SpeedType.STOP)\n  },\n\n  // methods\n\n  // setPlayerSpeed() {\n  //   this.player = this.player.getComponent('Player');\n  //   this.player.moveDir = p;\n  //   this.player.speedType = JoystickCommon.SpeedType.NORMAL;\n  // },\n});\n"]}